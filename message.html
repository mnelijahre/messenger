<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!--<meta http-equiv="refresh" content="2" />-->

</head>
<body>
    <h1 id="pageHeader">Works</h1>
    <div id="contentHolder">

    </div>
    <form id="myForm">
        <input type="text" id="contentInput">
        <button id="contentSubmitButton">Send</button>
    </form>

    <script type="module">
    
        /*=====================================================*/
    
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {getDatabase, set, get, update, remove, ref, child, onValue} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        const firebaseConfig = {
          apiKey: "AIzaSyD-FDKk4cgdYMnkjOqCD6Lm5DUgAeh9Qpc",
          authDomain: "tutorialwebsite-7cd7e.firebaseapp.com",
          databaseURL: "https://tutorialwebsite-7cd7e-default-rtdb.firebaseio.com",
          projectId: "tutorialwebsite-7cd7e",
          storageBucket: "tutorialwebsite-7cd7e.appspot.com",
          messagingSenderId: "122930750292",
          appId: "1:122930750292:web:5f982f3dda769246339ec1"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const dbref = ref(db);

        
    
    
        /*=====================================================*/
        

        pageHeader.innerHTML = "Welcome " + localStorage.getItem("user");

        const contentInput = document.querySelector("#contentInput");
        const contentSubmitButton = document.querySelector("#contentSubmitButton");
        const form = document.getElementById("myForm");
        
        function handleForm(event) { event.preventDefault(); } 
        form.addEventListener('submit', handleForm);

        var numCurTexts = 0;

        function contentSubmit(){
            var data = contentInput.value;
            var x;
            get(child(dbref, 'counter')).then((snapshot) =>{
                if (!snapshot.exists()){
                    set(ref(db, 'counter'),{
                        val: 0
                    })
                    return 0
                }else{
                    set(ref(db, 'counter'),{
                        val: snapshot.val().val + 1
                    })
                }
                return snapshot.val().val + 1 //this is bad but it works
                
            }).then((x)=>{
                numCurTexts = x,
                console.log(contentInput.value),
                update(ref(db, 'texts'), {
                    [x]: contentInput.value
                })
            })
            myRefresh();
        }

        contentSubmitButton.addEventListener('click', contentSubmit);


        function myRefresh(){
            var counter = 0;
            //contentHolder.innerHTML = "";
            onValue(child(dbref, "texts"), (snapshot) => {
            snapshot.forEach((childSnapshot) => {
                
                if (counter >= numCurTexts){
                const childKey = childSnapshot.key;
                const childData = childSnapshot.val();

                const x = document.createElement("p");
                x.innerHTML = childData;
                contentHolder.appendChild(x);
                }
                counter++;
            });
        }, {onlyOnce: true});
        }
        

        myRefresh();
    </script>
</body>
</html>
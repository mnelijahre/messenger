<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="message.css">
    <!--<meta http-equiv="refresh" content="2" />-->

</head>
<body>
    <div id="holder">
        <div id="a"></div>
        <div id="b"></div>
        <h1 id="pageHeader">Works</h1>

        <div id="contentHolder"></div>
        <form id="myForm">
            <input type="text" id="contentInput" autocomplete="off">
            <button id="contentSubmitButton">Send</button>
        </form>
    </div>
    





























    <script type="module">

        /*=====================================================*/
    
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {getDatabase, set, get, update, remove, ref, child, onValue} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        const firebaseConfig = {
          apiKey: "AIzaSyD-FDKk4cgdYMnkjOqCD6Lm5DUgAeh9Qpc",
          authDomain: "tutorialwebsite-7cd7e.firebaseapp.com",
          databaseURL: "https://tutorialwebsite-7cd7e-default-rtdb.firebaseio.com",
          projectId: "tutorialwebsite-7cd7e",
          storageBucket: "tutorialwebsite-7cd7e.appspot.com",
          messagingSenderId: "122930750292",
          appId: "1:122930750292:web:5f982f3dda769246339ec1"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const dbref = ref(db);

        
    
    
        
        /*=====================================================*/
        
        var firstLoad = true;
        var lastSeenKey = null;
        pageHeader.innerHTML = "Welcome " + localStorage.getItem("user");

        const contentInput = document.querySelector("#contentInput");
        const contentSubmitButton = document.querySelector("#contentSubmitButton");
        const form = document.getElementById("myForm");
        
        function handleForm(event) { event.preventDefault(); } 
        form.addEventListener('submit', handleForm);

        var numCurTexts = 0;

        function contentSubmit(){
            var data = contentInput.value;
            if (data == ""){
                return;
            }
            var x;
            get(child(dbref, 'counter')).then((snapshot) =>{
                if (!snapshot.exists()){
                    set(ref(db, 'counter'),{
                        val: 0
                    })
                    return 0
                }else{
                    set(ref(db, 'counter'),{
                        val: snapshot.val().val + 1
                    })
                }
                return snapshot.val().val + 1 //this is bad but it works
                
            }).then(async(x)=>{ //slight fix could be implemented here to make it lag less
                numCurTexts = x,
                await update(ref(db, 'texts/' + x), {
                    val: contentInput.value,
                    name: localStorage.getItem("user")
                })
                contentInput.value = ""
            })

            myRefresh();
        }

        contentSubmitButton.addEventListener('click', contentSubmit);


        function getNumCurTexts(){
            return get(child(dbref, 'counter')).then((snapshot)=>{
                if (!snapshot.exists()){
                    set(ref(db, 'counter'),{
                        val: 0
                    })
                    return 0
                }
                return snapshot.val().val
            })
        }



        async function myRefresh(){
            if (localStorage.getItem("user")=="undefined"){
                window.location.href = "index.html";
            }
            const snapshot = await get(child(dbref, "texts"));

            await onValue(child(dbref, "texts"), (snapshot) => {
            snapshot.forEach((childSnapshot) => {
                const childKey = childSnapshot.key;
                const childName = childSnapshot.val().name;
                const childData = childSnapshot.val().val;

                if(lastSeenKey == null || parseInt(childKey) > parseInt(lastSeenKey)){                    
                        lastSeenKey = childKey;
                        const div = document.createElement("div");
                        const datumName = document.createElement("b");
                        const datumContent = document.createElement("p");
                        div.classList.add("dataRow")
                        datumName.classList.add("datumName")
                        datumContent.classList.add("datumContent")
                        div.appendChild(datumName);
                        div.appendChild(datumContent);
                        datumName.innerHTML = childName;
                        datumContent.innerHTML = childData;
                        
                        contentHolder.appendChild(div);
                    
                
                    }
                });
            });
                if (firstLoad == true){
                    setTimeout(()=>{
                    const scrollableDiv = document.getElementById("contentHolder");
                    const lastElement = scrollableDiv.lastElementChild;
                    lastElement.scrollIntoView({ behavior:"instant" });
                    firstLoad = false;
                }, 150);
                }else{
                    setTimeout(()=>{
                    const scrollableDiv = document.getElementById("contentHolder");
                    const lastElement = scrollableDiv.lastElementChild;
                    console.log(lastElement)
                    lastElement.scrollIntoView({ behavior:"smooth" });
                }, 50);
                }
                
            }
            

        
        

        myRefresh();
    </script>
</body>
</html>